---
title: "GDA_CaseStudy_Analyze"
author: "Fred"
date: "4/22/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Case Study Roadmap - Analyze

Ask Three questions will guide the future marketing program:

    1. How do annual members and casual riders use Cyclistic bikes dierently?
    2. Why would casual riders buy Cyclistic annual memberships? 
    3. How can Cyclistic use digital media to influence casual riders to become members? 
    
You will produce a report with the following deliverables: 

    1. A clear statement of the business task - Completed
    2. A description of all data sources used - Completed
    3. Documentation of any cleaning or manipulation of data - Completed
    4. A summary of your analysis - In progress
    5. Supporting visualizations and key findings
    6. Your top three recommendations based on your analysis

Guiding questions

    - How should you organize your data to perform analysis on it?
    - Has your data been properly formatted?
    - What surprises did you discover in the data?
    - What trends or relationships did you find in the data?
    - How will these insights help answer your business questions?

Key tasks

    1. Aggregate your data so itâ€™s useful and accessible.
    2. Organize and format your data.
    3. Perform calculations
    4. Identify trends and relationships.

Deliverable

    - A summary of your analysis 

##### Start of cleaning and transformation
###### This analysis is for case study 1 from the Google Data Analytics Certificate (Cyclistic).  

###### Install required packages and library for data cleaning, transformation, and visualization.

```{r Install Packages, eval=FALSE, include=FALSE}
# # # # # # # # # # # # # # # # # # # # # # # 

install.packages("tidyverse")

### Load Necessary libraries
library(tidyverse)

```


##### Loading multiple .csv files as separate data frames
```{r Load csv files to dataframe, include=FALSE}
# path to folder that holds multiple .csv files

setwd("D:/Portfolio/GDA_Case_Study/Bike Share/data/divvy-tripdata/")  
file_list <- list.files()
csv <- lapply(file_list, read.csv)

all_trips <- do.call(rbind, csv)

```

##### Check data for consistency in reparation for cleaning and transoformation.


##### Inspect the new dataframe that has been created
```{r Inspect combined data, include=FALSE}
# Inspect the new dataframe that has been created

colnames(all_trips)  #List of column names
nrow(all_trips)  #How many rows are in data frame?
dim(all_trips)  #Dimensions of the data frame?
head(all_trips)  #See the first 6 rows of data frame.  Also tail(qs_raw)
str(all_trips)  #See list of columns and data types (numeric, character, etc)
summary(all_trips)  #Statistical summary of data. Mainly for numerics
#skim_without_charts(all_trips)
```


##### Transform Necessary Columns for calculation
```{r trnasform Columns , include=FALSE}

#Transform data

all_trips$start_date <- as.Date(all_trips$started_at)
all_trips$end_date <- as.Date(all_trips$ended_at)
all_trips$month <- format(as.Date(all_trips$start_date), "%m")
all_trips$day <- format(as.Date(all_trips$start_date), "%d")
all_trips$year <- format(as.Date(all_trips$start_date), "%Y")
all_trips$day_of_week <- format(as.Date(all_trips$start_date), "%A")

```

##### Create a ride length column
```{r Mutate Columns 3, include=FALSE}

#Create a ride_length column for calculation of trends. 
#Create a ride_length_hms column to display trip duration.
all_trips$ride_length <- difftime(all_trips$ended_at,all_trips$started_at)


is.factor(all_trips$ride_length)
all_trips$ride_length <- as.numeric(as.character(all_trips$ride_length))
is.numeric(all_trips$ride_length)


all_trips$ride_length_hms <- as.POSIXct(all_trips$ride_length, origin = "1960-01-01 00:00:00","GMT")
all_trips$ride_length_hms <- format(all_trips$ride_length_hms, format = "%H:%M:%S")



```


##### Remove bad data. 
```{r Remove bad data, include=FALSE}

## Remove data with less than 0 ride_length

all_trips_v2 <- all_trips[!(all_trips$start_station_name == "HQ QR" | tripdata_all$ride_length2<0),]


# Inspect the structure of the columns
str(tripdata_all)
str(tripdata_all_v2)

```


##### Perform initial analysis of data
```{r Initial Analysis}

# Descriptive analysis on ride_length (all figures in seconds)
mean(tripdata_all_v2$ride_length2) #straight average (total ride length / rides)
median(tripdata_all_v2$ride_length2) #midpoint number in the ascending array of ride lengths
max(tripdata_all_v2$ride_length2) #longest ride
min(tripdata_all_v2$ride_length2) #shortest ride

# You can condense the four lines above to one line using summary() on the specific attribute
summary(tripdata_all_v2$ride_length2)

```

##### Compare members and casual users - mean
```{r Compare members and casual users }
# Compare members and casual users
aggregate(tripdata_all_v2$ride_length2 ~ tripdata_all_v2$member_casual, FUN = mean)
```

##### Compare members and casual users - median
```{r Compare members and casual users 2}
aggregate(tripdata_all_v2$ride_length2 ~ tripdata_all_v2$member_casual, FUN = median)
```

##### Compare members and casual users - max
```{r Compare members and casual users 3}
aggregate(tripdata_all_v2$ride_length2 ~ tripdata_all_v2$member_casual, FUN = max)
```

##### Compare members and casual users - min
```{r Compare members and casual users 4}
aggregate(tripdata_all_v2$ride_length2 ~ tripdata_all_v2$member_casual, FUN = min)
```

##### See the average ride time by each day for members vs casual users
```{r See the average ride time by each day for members vs casual users, include=FALSE}

# See the average ride time by each day for members vs casual users
aggregate(tripdata_all_v2$ride_length2 ~ tripdata_all_v2$member_casual + tripdata_all_v2$day_of_week, FUN = mean)

```


##### Minor fix on Day of week
```{r Fix week order, include=FALSE}
# Notice that the days of the week are out of order. Let's fix that.
tripdata_all_v2$day_of_week <- ordered(tripdata_all_v2$day_of_week, levels=c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))

```

##### See the average ride time by each day for members vs casual users
```{r See the average ride time by each day for members vs casual users 2}
# Now, let's run the average ride time by each day for members vs casual users
aggregate(tripdata_all_v2$ride_length2 ~ tripdata_all_v2$member_casual + tripdata_all_v2$day_of_week, FUN = mean)

```

##### analyze ridership data by type and weekday
```{r analyze ridership data by type and weekday}

# analyze ridership data by type and weekday
tripdata_all_v2 %>% 
  mutate(weekday = wday(started_at, label = TRUE)) %>%  #creates weekday field using wday()
  group_by(member_casual, weekday) %>%  #groups by usertype and weekday
  summarise(number_of_rides = n()						#calculates the number of rides and average duration 
  ,average_duration = mean(ride_length2)) %>% 		# calculates the average duration
  arrange(member_casual, weekday)		
```

##### Visualize the number of rides by rider type
```{r Lets visualize the number of rides by rider type}
# Let's visualize the number of rides by rider type
tripdata_all_v2 %>% 
  mutate(weekday = wday(started_at, label = TRUE)) %>% 
  group_by(member_casual, weekday) %>% 
  summarise(number_of_rides = n(), average_duration = mean(ride_length2)) %>% 
  arrange(member_casual, weekday)  %>% 
  ggplot(aes(x = weekday, y = number_of_rides, fill = member_casual)) +
  geom_col(position = "stack")
  theme(axis.text.x = element_text(angle = 45)) +
  theme(axis.text.y = element_text(margin = 100))) 

```

##### Create a visualization for average duration
```{r Lets create a visualization for average duration}
# Let's create a visualization for average duration
tripdata_all_v2 %>% 
  mutate(weekday = wday(started_at, label = TRUE)) %>% 
  group_by(member_casual, weekday) %>% 
  summarise(number_of_rides = n(), average_duration = mean(ride_length2)) %>% 
  arrange(member_casual, weekday)  %>% 
  ggplot(aes(x = weekday, y = average_duration, fill = member_casual)) +
  geom_col(position = "dodge")

```

#####
```{r eval=FALSE, include=FALSE}
counts <- aggregate(tripdata_all_v2$ride_length2 ~ tripdata_all_v2$member_casual + tripdata_all_v2$day_of_week, FUN = mean)
write.csv(counts, file = 'D:/Portfolio/GDA_Case_Study/Bike Share/data/divvy-tripdata/avg_ride_length.csv')
```


