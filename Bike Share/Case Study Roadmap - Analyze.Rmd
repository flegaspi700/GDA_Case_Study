---
title: "GDA_CaseStudy_Analyze"
author: "Fred"
date: "4/22/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Case Study Roadmap - Analyze

Ask Three questions will guide the future marketing program:

    1. How do annual members and casual riders use Cyclistic bikes dierently?
    2. Why would casual riders buy Cyclistic annual memberships? 
    3. How can Cyclistic use digital media to influence casual riders to become members? 
    
You will produce a report with the following deliverables: 

    1. A clear statement of the business task - Completed
    2. A description of all data sources used - Completed
    3. Documentation of any cleaning or manipulation of data - Completed
    4. A summary of your analysis - In progress
    5. Supporting visualizations and key findings
    6. Your top three recommendations based on your analysis

Guiding questions

    - How should you organize your data to perform analysis on it?
    - Has your data been properly formatted?
    - What surprises did you discover in the data?
    - What trends or relationships did you find in the data?
    - How will these insights help answer your business questions?

Key tasks

    1. Aggregate your data so itâ€™s useful and accessible.
    2. Organize and format your data.
    3. Perform calculations
    4. Identify trends and relationships.

Deliverable

    - A summary of your analysis 

##### Start of cleaning and transformation
###### This analysis is for case study 1 from the Google Data Analytics Certificate (Cyclistic).  

###### Install required packages for data cleaning, transformation, and visualization.

```{r Install Packages, eval=FALSE, include=FALSE}
# # # # # # # # # # # # # # # # # # # # # # # 

install.packages("tidyverse")
install.packages("here")
install.packages("skimr")
install.packages("janitor")
install.packages("dplyr")
install.packages("tidyr")
install.packages("rmarkdown")
install.packages("ggplot2")
install.packages("lubridate")
```

##### Load required libraries.
```{r load Libraries}
### Load Necessary libraries
library(tidyverse)
library(here)
library(skimr)
library(janitor)
library(dplyr)
library(tidyr)
library(rmarkdown)
library(ggplot2)
library(lubridate)
```

##### Loading multiple .csv files as separate data frames
```{r Load csv files to dataframe, include=FALSE}
# path to folder that holds multiple .csv files

folder <- "D:/Portfolio/GDA_Case_Study/Bike Share/data/divvy-tripdata/"   

file_list <- list.files(path = folder, pattern = "*.csv")

# read in each .csv file in file_list and create a data frame with name tripdate_<date>
for (i in 1:length(file_list)){
  assign(paste("tripdata_", substr(file_list[i], 1, 6), sep = ''), 
  read.csv(paste(folder, file_list[i], sep=''))
)}
```

##### Check data for consistency in reparation for cleaning and transoformation.
##### Check dataframe column names
```{r Check Column Names, include=FALSE}
#Check for column names for consistency

colnames(tripdata_202004)
colnames(tripdata_202005)
colnames(tripdata_202006)
colnames(tripdata_202007)
colnames(tripdata_202008)
colnames(tripdata_202009)
colnames(tripdata_202010)
colnames(tripdata_202011)
colnames(tripdata_202012)
colnames(tripdata_202101)
colnames(tripdata_202102)
colnames(tripdata_202103)

```

###### Check dataframe structure
```{r Check Structure, include=FALSE}
#Check structure for consistency

str(tripdata_202004)
str(tripdata_202005)
str(tripdata_202006)
str(tripdata_202007)
str(tripdata_202008)
str(tripdata_202009)
str(tripdata_202010)
str(tripdata_202011)
str(tripdata_202012)
str(tripdata_202101)
str(tripdata_202102)
str(tripdata_202103)
```

##### Check the number of rows 
```{r Number of rows, include=FALSE}
#Check Number of rows for consistency

nrow(tripdata_202004)
nrow(tripdata_202005)
nrow(tripdata_202006)
nrow(tripdata_202007)
nrow(tripdata_202008)
nrow(tripdata_202009)
nrow(tripdata_202010)
nrow(tripdata_202011)
nrow(tripdata_202012)
nrow(tripdata_202101)
nrow(tripdata_202102)
nrow(tripdata_202103)
```

##### Check dataframe Dimensions
```{r Dimension of dataframe, include=FALSE}
#Check Dimension of dataframe for consistency

dim(tripdata_202004)
dim(tripdata_202005)
dim(tripdata_202006)
dim(tripdata_202007)
dim(tripdata_202008)
dim(tripdata_202009)
dim(tripdata_202010)
dim(tripdata_202011)
dim(tripdata_202012)
dim(tripdata_202101)
dim(tripdata_202102)
dim(tripdata_202103)
```

##### Check dataframe Summary
```{r Check Summary of dataframe, include=FALSE}
#Check Summary for consistency, and Null values

summary(tripdata_202004)
summary(tripdata_202005)
summary(tripdata_202006)
summary(tripdata_202007)
summary(tripdata_202008)
summary(tripdata_202009)
summary(tripdata_202010)
summary(tripdata_202011)
summary(tripdata_202012)
summary(tripdata_202101)
summary(tripdata_202102)
summary(tripdata_202103)

```

##### Check first 6 rows
```{r Check first 6 rows of dataframe, include=FALSE}
#Check first 6 rows of dataframe

head(tripdata_202004)
head(tripdata_202005)
head(tripdata_202006)
head(tripdata_202007)
head(tripdata_202008)
head(tripdata_202009)
head(tripdata_202010)
head(tripdata_202011)
head(tripdata_202012)
head(tripdata_202101)
head(tripdata_202102)
head(tripdata_202103)

```

##### Merge files to single dataframe
```{r Merge Files, include=FALSE}
#Merge Files to a single data frame
tripdata_all <- rbind(tripdata_202004, tripdata_202005, tripdata_202006, tripdata_202007, tripdata_202008, tripdata_202009, tripdata_202010, tripdata_202011, tripdata_202012, tripdata_202101, tripdata_202102, tripdata_202103)

```

##### Inspect the new dataframe that has been created
```{r Inspect combined data, include=FALSE}
# Inspect the new dataframe that has been created

colnames(tripdata_all)  #List of column names
nrow(tripdata_all)  #How many rows are in data frame?
dim(tripdata_all)  #Dimensions of the data frame?
head(tripdata_all)  #See the first 6 rows of data frame.  Also tail(qs_raw)
str(tripdata_all)  #See list of columns and data types (numeric, character, etc)
summary(tripdata_all)  #Statistical summary of data. Mainly for numerics
skim_without_charts(tripdata_all)
```

##### Transform Necessary Columns for calculation
```{r Mutate Columns, include=FALSE}
# Transform Necessary Columns

tripdata_all <- mutate(tripdata_all, ride_id = as.character(ride_id)
                  ,rideable_type = as.character(rideable_type)) 

tripdata_all <- mutate(tripdata_all, started_date = as_datetime(started_at))

tripdata_all <- mutate(tripdata_all, ended_date = as_datetime(ended_at))

tripdata_all <- mutate(tripdata_all, ride_length = difftime(ended_date, started_date, units = "mins"))

tripdata_all <- mutate(tripdata_all, ride_length = as.numeric(ride_length))

tripdata_all <- mutate(tripdata_all, ride_length = as.POSIXct(ride_length*60, origin = "1960-01-01 00:00:00","GMT"))

tripdata_all <- mutate(tripdata_all, ride_length = format(ride_length, format = "%H:%M:%S"))

tripdata_all <- mutate(tripdata_all, week_of_day = wday(as.Date(started_date), label=TRUE, abbr = FALSE, week_start = 1))

```

##### Transform Necessary Columns for calculation
```{r Mutate Columns 2, include=FALSE}

#Transform additional data

tripdata_all$date <- as.Date(tripdata_all$started_at)
tripdata_all$month <- format(as.Date(tripdata_all$date), "%m")
tripdata_all$day <- format(as.Date(tripdata_all$date), "%d")
tripdata_all$year <- format(as.Date(tripdata_all$date), "%Y")
tripdata_all$day_of_week <- format(as.Date(tripdata_all$date), "%A")

```

##### Verify if column is numeric
```{r Mutate Columns 3, include=FALSE}

tripdata_all$ride_length2 <- difftime(tripdata_all$ended_at,tripdata_all$started_at)

is.factor(tripdata_all$ride_length2)
tripdata_all$ride_length2 <- as.numeric(as.character(tripdata_all$ride_length2))
is.numeric(tripdata_all$ride_length2)

```


##### Remove bad data. 
```{r Remove bad data, include=FALSE}

## Remove data with less than 0 ride_length

tripdata_all_v2 <- tripdata_all[!(tripdata_all$start_station_name == "HQ QR" | tripdata_all$ride_length2<0),]


# Inspect the structure of the columns
str(tripdata_all)
str(tripdata_all_v2)

```


##### Perform initial analysis of data
```{r Initial Analysis}

# Descriptive analysis on ride_length (all figures in seconds)
mean(tripdata_all_v2$ride_length2) #straight average (total ride length / rides)
median(tripdata_all_v2$ride_length2) #midpoint number in the ascending array of ride lengths
max(tripdata_all_v2$ride_length2) #longest ride
min(tripdata_all_v2$ride_length2) #shortest ride

# You can condense the four lines above to one line using summary() on the specific attribute
summary(tripdata_all_v2$ride_length2)

```

##### Compare members and casual users - mean
```{r Compare members and casual users }
# Compare members and casual users
aggregate(tripdata_all_v2$ride_length2 ~ tripdata_all_v2$member_casual, FUN = mean)
```

##### Compare members and casual users - median
```{r Compare members and casual users 2}
aggregate(tripdata_all_v2$ride_length2 ~ tripdata_all_v2$member_casual, FUN = median)
```

##### Compare members and casual users - max
```{r Compare members and casual users 3}
aggregate(tripdata_all_v2$ride_length2 ~ tripdata_all_v2$member_casual, FUN = max)
```

##### Compare members and casual users - min
```{r Compare members and casual users 4}
aggregate(tripdata_all_v2$ride_length2 ~ tripdata_all_v2$member_casual, FUN = min)
```

##### See the average ride time by each day for members vs casual users
```{r See the average ride time by each day for members vs casual users, include=FALSE}

# See the average ride time by each day for members vs casual users
aggregate(tripdata_all_v2$ride_length2 ~ tripdata_all_v2$member_casual + tripdata_all_v2$day_of_week, FUN = mean)

```

##### Minor fix on Day of week
```{r Fix week order, include=FALSE}
# Notice that the days of the week are out of order. Let's fix that.
tripdata_all_v2$day_of_week <- ordered(tripdata_all_v2$day_of_week, levels=c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))

```

##### See the average ride time by each day for members vs casual users
```{r See the average ride time by each day for members vs casual users 2}
# Now, let's run the average ride time by each day for members vs casual users
aggregate(tripdata_all_v2$ride_length2 ~ tripdata_all_v2$member_casual + tripdata_all_v2$day_of_week, FUN = mean)

```

##### analyze ridership data by type and weekday
```{r analyze ridership data by type and weekday}

# analyze ridership data by type and weekday
tripdata_all_v2 %>% 
  mutate(weekday = wday(started_at, label = TRUE)) %>%  #creates weekday field using wday()
  group_by(member_casual, weekday) %>%  #groups by usertype and weekday
  summarise(number_of_rides = n()						#calculates the number of rides and average duration 
  ,average_duration = mean(ride_length2)) %>% 		# calculates the average duration
  arrange(member_casual, weekday)		
```


##### Visualize the number of rides by rider type
```{r Lets visualize the number of rides by rider type}
# Let's visualize the number of rides by rider type
tripdata_all_v2 %>% 
  mutate(weekday = wday(started_at, label = TRUE)) %>% 
  group_by(member_casual, weekday) %>% 
  summarise(number_of_rides = n(), average_duration = mean(ride_length2)) %>% 
  arrange(member_casual, weekday)  %>% 
  ggplot(aes(x = weekday, y = number_of_rides, fill = member_casual)) +
  geom_col(position = "dodge")

```

##### Create a visualization for average duration
```{r Lets create a visualization for average duration}
# Let's create a visualization for average duration
tripdata_all_v2 %>% 
  mutate(weekday = wday(started_at, label = TRUE)) %>% 
  group_by(member_casual, weekday) %>% 
  summarise(number_of_rides = n(), average_duration = mean(ride_length2)) %>% 
  arrange(member_casual, weekday)  %>% 
  ggplot(aes(x = weekday, y = average_duration, fill = member_casual)) +
  geom_col(position = "dodge")

```

#####
```{r eval=FALSE, include=FALSE}
counts <- aggregate(tripdata_all_v2$ride_length2 ~ tripdata_all_v2$member_casual + tripdata_all_v2$day_of_week, FUN = mean)
write.csv(counts, file = 'D:/Portfolio/GDA_Case_Study/Bike Share/data/divvy-tripdata/avg_ride_length.csv')
```


